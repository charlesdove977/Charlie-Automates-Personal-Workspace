---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Set up Prisma ORM with Supabase connection and create the initial database schema.

Purpose: Establish the data layer with models for firms, users, cases, and documents that the entire system will use.
Output: Prisma schema with core models, database connection configured, types generated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Data model requirements from PROJECT.md:**
- Firms: Law firm accounts (multi-tenant)
- Users: Attorneys who review cases
- Cases: Submitted intake forms with status
- Documents: Uploaded files attached to cases

**Key considerations:**
- Each firm is siloed (no cross-firm data access)
- Cases have clear lifecycle: submitted → pending → accepted/rejected
- Documents need secure storage references
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Prisma with Supabase</name>
  <files>prisma/schema.prisma, src/lib/db.ts, package.json</files>
  <action>
    Install and configure Prisma:

    1. Install dependencies:
       `pnpm add prisma @prisma/client`
       `pnpm add -D prisma`

    2. Initialize Prisma:
       `pnpm prisma init`

    3. Update `prisma/schema.prisma` datasource:
       ```prisma
       datasource db {
         provider  = "postgresql"
         url       = env("DATABASE_URL")
         directUrl = env("DIRECT_URL")
       }

       generator client {
         provider = "prisma-client-js"
       }
       ```

    4. Create `src/lib/db.ts` for Prisma client singleton:
       ```typescript
       import { PrismaClient } from '@prisma/client'

       const globalForPrisma = globalThis as unknown as {
         prisma: PrismaClient | undefined
       }

       export const db = globalForPrisma.prisma ?? new PrismaClient()

       if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = db
       ```

    DO NOT run migrations yet - schema comes in Task 2.
  </action>
  <verify>
    cat prisma/schema.prisma - should show postgresql datasource
    cat src/lib/db.ts - should export db client
    pnpm prisma validate - should pass (even without models)
  </verify>
  <done>Prisma configured with Supabase connection, db client singleton created</done>
</task>

<task type="auto">
  <name>Task 2: Create initial database schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add core models to `prisma/schema.prisma`:

    ```prisma
    model Firm {
      id        String   @id @default(cuid())
      name      String
      slug      String   @unique
      logo      String?
      primaryColor String @default("#1a365d")
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      users     User[]
      cases     Case[]
      fitCriteria FitCriteria[]
    }

    model User {
      id        String   @id @default(cuid())
      email     String   @unique
      name      String
      role      UserRole @default(ATTORNEY)
      firmId    String
      firm      Firm     @relation(fields: [firmId], references: [id])
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      @@index([firmId])
    }

    enum UserRole {
      ADMIN
      ATTORNEY
    }

    model Case {
      id            String     @id @default(cuid())
      firmId        String
      firm          Firm       @relation(fields: [firmId], references: [id])
      status        CaseStatus @default(PENDING)

      // Client info
      clientName    String
      clientEmail   String
      clientPhone   String?

      // Case details
      caseType      String?
      jurisdiction  String?

      // AI analysis results (populated by Phase 3)
      briefJson     Json?
      fitScore      Int?

      // Timestamps
      submittedAt   DateTime   @default(now())
      reviewedAt    DateTime?
      createdAt     DateTime   @default(now())
      updatedAt     DateTime   @updatedAt

      documents     Document[]

      @@index([firmId])
      @@index([status])
    }

    enum CaseStatus {
      PENDING
      ACCEPTED
      REJECTED
    }

    model Document {
      id          String   @id @default(cuid())
      caseId      String
      case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

      filename    String
      mimeType    String
      sizeBytes   Int
      storageUrl  String   // Supabase storage URL

      // Extracted content (populated by Phase 3)
      extractedText String?

      createdAt   DateTime @default(now())

      @@index([caseId])
    }

    model FitCriteria {
      id          String   @id @default(cuid())
      firmId      String
      firm        Firm     @relation(fields: [firmId], references: [id])

      name        String
      description String?
      weight      Int      @default(1)
      isActive    Boolean  @default(true)

      createdAt   DateTime @default(now())
      updatedAt   DateTime @updatedAt

      @@index([firmId])
    }
    ```

    After adding models:
    1. Run `pnpm prisma validate` to check syntax
    2. Run `pnpm prisma generate` to generate TypeScript types

    DO NOT run migrations (`prisma migrate dev`) - that requires actual database connection.
    User will run migrations after setting up Supabase credentials.
  </action>
  <verify>
    pnpm prisma validate - should pass
    pnpm prisma generate - should generate client
    Check node_modules/.prisma/client exists
  </verify>
  <done>Schema has Firm, User, Case, Document, FitCriteria models; Prisma types generated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm prisma validate` passes
- [ ] `pnpm prisma generate` succeeds
- [ ] `src/lib/db.ts` exports db client
- [ ] Schema includes: Firm, User, Case, Document, FitCriteria models
- [ ] Proper indexes on foreign keys
- [ ] Enums for UserRole and CaseStatus
- [ ] `pnpm build` still succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Prisma client types available in IDE
- No TypeScript errors when importing db
- Schema ready for migration when database credentials available
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
