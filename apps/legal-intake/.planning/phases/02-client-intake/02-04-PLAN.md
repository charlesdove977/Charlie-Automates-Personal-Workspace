---
phase: 02-client-intake
plan: 04
type: execute
---

<objective>
Create the case submission API endpoint that handles form data and file uploads to Supabase Storage.

Purpose: Complete the intake flow by persisting case data and documents to the database and storage.
Output: Working POST /api/cases/submit endpoint that creates Case and Document records with file storage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-client-intake/02-03-SUMMARY.md

# Key files:
@src/lib/supabase/server.ts
@src/lib/db.ts
@src/lib/api.ts
@prisma/schema.prisma

**Tech stack available:** Next.js 16.1.1, React 19, Prisma 7, @supabase/ssr
**Established patterns:** API response utilities, Prisma singleton, multi-tenant by firmId

**Constraining decisions:**
- All entities linked to Firm for data isolation
- Document storageUrl points to Supabase Storage
- Case starts with PENDING status
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create case submission API endpoint</name>
  <files>src/app/api/cases/submit/route.ts</files>
  <action>
1. Create POST handler at src/app/api/cases/submit/route.ts:
   - Parse multipart/form-data request (use request.formData())
   - Extract fields: firmSlug, clientName, clientEmail, clientPhone, caseType, jurisdiction, briefDescription
   - Extract files array from form data
   - Validate required fields: firmSlug, clientName, clientEmail, caseType
   - Validate email format
   - Look up Firm by slug, return 404 if not found

2. Create Case record in database:
   - Use Prisma client from src/lib/db.ts
   - Set status to PENDING (default)
   - Store client info and case details
   - Store briefDescription in a JSON field or as caseType details

3. Return response:
   - Success: 201 with { caseId, message: "Case submitted successfully" }
   - Validation error: 400 with { error: "description" }
   - Firm not found: 404 with { error: "Firm not found" }
   - Server error: 500 with { error: "Submission failed" }

Use jsonResponse, badRequest, notFound, errorResponse from src/lib/api.ts
  </action>
  <verify>curl -X POST /api/cases/submit with form data creates Case in database, returns 201</verify>
  <done>POST /api/cases/submit creates Case record with proper validation and error handling</done>
</task>

<task type="auto">
  <name>Task 2: Handle file upload to Supabase Storage</name>
  <files>src/app/api/cases/submit/route.ts, src/lib/storage.ts</files>
  <action>
1. Create src/lib/storage.ts utility:
   - Export uploadDocument(file: File, firmId: string, caseId: string): Promise<{ url: string, error?: string }>
   - Use server Supabase client with service role key for storage operations
   - Upload to path: case-documents/{firmId}/{caseId}/{timestamp}-{filename}
   - Return public URL or signed URL depending on bucket config
   - Handle errors gracefully

2. Update POST /api/cases/submit/route.ts:
   - After creating Case, iterate through uploaded files
   - For each file:
     * Validate file type (pdf, doc, docx, jpg, jpeg, png)
     * Validate file size (max 10MB)
     * Call uploadDocument() to store in Supabase
     * Create Document record in database with:
       - caseId
       - filename (original name)
       - mimeType
       - sizeBytes
       - storageUrl (from upload result)
   - If any upload fails, still save the Case but note partial upload in response
   - Return list of uploaded document IDs in response

3. Transaction handling:
   - Use Prisma.$transaction for Case + Documents creation
   - If file upload fails after Case created, mark documents as failed (or skip creating Document record)
  </action>
  <verify>Submit with files creates Case + Document records, files appear in Supabase Storage bucket</verify>
  <done>Files uploaded to Supabase Storage, Document records created with storageUrl references</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete intake submission flow: form → API → database → storage</what-built>
  <how-to-verify>
    1. Ensure Supabase project has storage bucket "case-documents" created
    2. Set environment variables in .env.local:
       - NEXT_PUBLIC_SUPABASE_URL
       - NEXT_PUBLIC_SUPABASE_ANON_KEY
       - SUPABASE_SERVICE_ROLE_KEY
    3. Run database migration: `pnpm prisma db push`
    4. Seed a test firm: Use Prisma Studio or direct SQL
    5. Start dev server: `pnpm dev`
    6. Navigate to /[test-firm-slug]/intake
    7. Fill out form with test data
    8. Upload a test PDF document
    9. Submit the form
    10. Verify:
        - Case appears in database (Prisma Studio)
        - Document record has storageUrl
        - File exists in Supabase Storage bucket
        - Success message displayed to user
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] `pnpm lint` passes
- [ ] POST /api/cases/submit creates Case record
- [ ] Files upload to Supabase Storage successfully
- [ ] Document records link to uploaded files
- [ ] Form submission shows success to user
</verification>

<success_criteria>

- Case submission API creates Case and Document records
- Files stored in Supabase Storage with proper paths
- Multi-tenant isolation via firmId
- Error handling for validation, missing firm, upload failures
- Phase 2 complete: clients can submit intake forms with documents
</success_criteria>

<output>
After completion, create `.planning/phases/02-client-intake/02-04-SUMMARY.md` following the summary template.

Include in summary:
- Phase 2 complete status
- List all components built across 4 plans
- Ready for Phase 3: AI Analysis Engine
</output>
