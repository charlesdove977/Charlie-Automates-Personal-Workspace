---
phase: 03-ai-analysis
plan: 02
type: execute
---

<objective>
Integrate Claude API for AI-powered case analysis and structured brief generation.

Purpose: Analyze extracted document text to produce structured case briefs for attorney review.
Output: Working Claude analysis service that generates case briefs with structured JSON output.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/03-ai-analysis/03-01-SUMMARY.md

# Key files:
@src/lib/extraction.ts
@src/lib/db.ts
@prisma/schema.prisma

**Tech stack available:** Next.js 16.1.1, React 19, Prisma 7
**Established patterns:** API response utilities, Prisma singleton, multi-tenant by firmId

**Constraining decisions:**
- AI acts like a junior paralegal: summarize, not advise
- Extract facts, not opinions
- Flag uncertainty clearly
- Never interpret law or recommend action
- Case.briefJson stores structured analysis
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and configure</name>
  <files>package.json, src/lib/claude.ts, .env.example</files>
  <action>
1. Install Anthropic SDK:
   ```bash
   pnpm add @anthropic-ai/sdk
   ```

2. Create src/lib/claude.ts:
   - Import Anthropic from @anthropic-ai/sdk
   - Create singleton function getClaudeClient() that returns Anthropic instance
   - Use ANTHROPIC_API_KEY from environment
   - Export the client getter

3. Add ANTHROPIC_API_KEY to .env.example (if it exists) or create .env.local.example:
   ```
   ANTHROPIC_API_KEY=sk-ant-...
   ```
  </action>
  <verify>Anthropic SDK installed, client can be instantiated</verify>
  <done>Claude SDK configured with API key from environment</done>
</task>

<task type="auto">
  <name>Task 2: Define case brief JSON schema and types</name>
  <files>src/types/case-brief.ts</files>
  <action>
Create src/types/case-brief.ts with structured case brief types:

```typescript
export interface CaseBrief {
  caseType: {
    primary: string           // e.g., "Divorce", "Custody", "Child Support"
    secondary?: string[]      // Additional case types if multiple
    confidence: 'high' | 'medium' | 'low'
  }
  jurisdiction: {
    state?: string
    county?: string
    confidence: 'high' | 'medium' | 'low'
    source?: string           // Where this was detected
  }
  parties: {
    petitioner?: PartyInfo
    respondent?: PartyInfo
    children?: ChildInfo[]
    otherParties?: PartyInfo[]
  }
  timeline: TimelineEvent[]
  keyFacts: KeyFact[]
  redFlags: RedFlag[]
  summary: string             // 2-3 sentence summary
  uncertainties: Uncertainty[]
  analysisMetadata: {
    documentCount: number
    totalTextLength: number
    processingTime: number
    modelUsed: string
    timestamp: string
  }
}

export interface PartyInfo {
  name?: string
  role: string
  details?: string
  confidence: 'high' | 'medium' | 'low'
}

export interface ChildInfo {
  name?: string
  age?: number
  custody?: string
  confidence: 'high' | 'medium' | 'low'
}

export interface TimelineEvent {
  date?: string
  description: string
  source: string              // Which document this came from
  confidence: 'high' | 'medium' | 'low'
}

export interface KeyFact {
  fact: string
  category: 'financial' | 'custody' | 'property' | 'domestic' | 'procedural' | 'other'
  importance: 'high' | 'medium' | 'low'
  source: string
  confidence: 'high' | 'medium' | 'low'
}

export interface RedFlag {
  issue: string
  severity: 'high' | 'medium' | 'low'
  details: string
  source: string
}

export interface Uncertainty {
  area: string
  reason: string
  needsHumanReview: boolean
}
```

These types define the structured output Claude will generate.
  </action>
  <verify>TypeScript compiles, types can be imported</verify>
  <done>Case brief JSON schema defined with confidence levels and uncertainty tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create Claude analysis service with prompts</name>
  <files>src/lib/analysis.ts</files>
  <action>
Create src/lib/analysis.ts with the analysis service:

1. Import types from case-brief.ts and claude client

2. Create the system prompt (CRITICAL - this defines AI behavior):
```typescript
const SYSTEM_PROMPT = `You are a legal document analyst assistant helping attorneys review case intake documents.

YOUR ROLE:
- Act like a junior paralegal summarizing documents for attorney review
- Extract facts only - never interpret law or give legal advice
- Summarize, don't advise
- Flag anything uncertain clearly

STRICT RULES:
- NEVER recommend legal action or strategy
- NEVER interpret what the law means for this case
- NEVER predict case outcomes
- ONLY extract and organize facts from the documents
- ALWAYS flag low-confidence extractions
- When information is missing or unclear, explicitly note it

OUTPUT FORMAT:
You must respond with valid JSON matching the CaseBrief schema provided.
Every extraction must include a confidence level (high/medium/low).
Use "low" confidence for anything inferred rather than explicitly stated.`
```

3. Export async function analyzeCase(documents: DocumentWithText[], caseType?: string): Promise<CaseBrief>
   - Build user prompt with:
     * All extracted document text (concatenated with document names)
     * Case type hint if provided
     * Request for JSON output matching CaseBrief schema
   - Call Claude API with:
     * model: 'claude-sonnet-4-20250514' (or claude-3-5-sonnet-20241022)
     * system: SYSTEM_PROMPT
     * max_tokens: 4096
     * temperature: 0 (for consistent extraction)
   - Parse JSON response
   - Add analysisMetadata (processing time, model, timestamp)
   - Return CaseBrief

4. Handle errors:
   - JSON parse failures: return partial result with error in uncertainties
   - API errors: throw with descriptive message
   - Token limit: truncate documents, note in uncertainties

5. Add logging for analysis timing
  </action>
  <verify>analyzeCase function compiles and can call Claude API</verify>
  <done>Claude analysis service with structured prompts for case brief generation</done>
</task>

<task type="auto">
  <name>Task 4: Create analysis API endpoint</name>
  <files>src/app/api/cases/[caseId]/analyze/route.ts</files>
  <action>
Create POST endpoint to trigger AI analysis for a case:

1. Create src/app/api/cases/[caseId]/analyze/route.ts:
   - Validate caseId parameter
   - Look up Case with Documents using Prisma
   - Return 404 if case not found

2. Validation checks:
   - Ensure documents have extractedText (if not, return 400 "Run extraction first")
   - Check at least one document has text to analyze

3. Call analyzeCase() with documents:
   - Map Documents to include id, filename, extractedText
   - Pass caseType from Case if available

4. Update Case.briefJson with the returned CaseBrief

5. Return response:
   - Success: 200 with { success: true, brief: CaseBrief }
   - Case not found: 404
   - No extracted text: 400 with { error: "Documents must be extracted first" }
   - Server error: 500

6. Add cache-control headers
  </action>
  <verify>POST /api/cases/[caseId]/analyze generates and stores case brief</verify>
  <done>API endpoint triggers Claude analysis and stores result in Case.briefJson</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Claude AI analysis service with structured case brief generation</what-built>
  <how-to-verify>
    1. Ensure ANTHROPIC_API_KEY is set in .env.local
    2. Have a test case with extracted document text
    3. Start dev server: `pnpm dev`
    4. Call the analysis endpoint:
       ```bash
       curl -X POST http://localhost:3000/api/cases/[test-case-id]/analyze
       ```
    5. Verify:
       - Response contains structured CaseBrief JSON
       - Case.briefJson updated in database
       - Brief contains: caseType, jurisdiction, parties, timeline, keyFacts
       - Red flags identified if present
       - Uncertainties flagged for low-confidence extractions
       - AI does NOT give legal advice or recommendations
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] `pnpm lint` passes
- [ ] Anthropic SDK successfully calls Claude API
- [ ] Case briefs generated with all required fields
- [ ] Confidence levels included on extractions
- [ ] Uncertainties properly flagged
- [ ] AI output stays within "paralegal" boundaries (no advice)
- [ ] Case.briefJson stored correctly
</verification>

<success_criteria>
- Claude API integration working
- Structured case briefs generated from document text
- Confidence levels on all extractions
- Uncertainty flagging system functional
- AI behavior constrained to fact extraction only
- Ready for pipeline integration in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-analysis/03-02-SUMMARY.md` following the summary template.

Include in summary:
- Claude model used
- Prompt engineering decisions
- Any refinements to brief structure
</output>
