---
phase: 03-ai-analysis
plan: 01
type: execute
---

<objective>
Set up document text extraction for uploaded PDFs and DOCX files.

Purpose: Extract text content from case documents so AI can analyze them.
Output: Working extraction service that populates Document.extractedText for all document types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context:
@.planning/phases/02-client-intake/02-04-SUMMARY.md

# Key files:
@src/lib/storage.ts
@src/lib/db.ts
@prisma/schema.prisma

**Tech stack available:** Next.js 16.1.1, React 19, Prisma 7, Supabase Storage
**Established patterns:** API response utilities, Prisma singleton, multi-tenant by firmId

**Constraining decisions:**
- Documents stored in Supabase Storage with public URLs
- Document.extractedText field exists for storing parsed text
- Allowed types: PDF, DOC, DOCX, JPG, JPEG, PNG
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install document parsing dependencies</name>
  <files>package.json</files>
  <action>
Install document parsing libraries:

1. For PDF extraction, install pdf-parse:
   ```bash
   pnpm add pdf-parse
   pnpm add -D @types/pdf-parse
   ```

2. For DOCX extraction, install mammoth:
   ```bash
   pnpm add mammoth
   ```

Note: Images (JPG, PNG) will use OCR in a future enhancement. For now, skip image extraction.
  </action>
  <verify>pnpm install succeeds, packages in package.json</verify>
  <done>pdf-parse and mammoth installed for document text extraction</done>
</task>

<task type="auto">
  <name>Task 2: Create text extraction service</name>
  <files>src/lib/extraction.ts</files>
  <action>
Create src/lib/extraction.ts with extraction utilities:

1. Export interface ExtractionResult:
   ```typescript
   export interface ExtractionResult {
     text: string | null
     error?: string
     pageCount?: number
   }
   ```

2. Export async function extractFromPdf(buffer: Buffer): Promise<ExtractionResult>
   - Use pdf-parse to extract text
   - Return extracted text, page count
   - Handle errors gracefully (corrupted PDFs, password-protected)

3. Export async function extractFromDocx(buffer: Buffer): Promise<ExtractionResult>
   - Use mammoth to extract text (use extractRawText, not convertToHtml)
   - Return extracted text
   - Handle errors gracefully

4. Export async function extractTextFromDocument(url: string, mimeType: string): Promise<ExtractionResult>
   - Fetch document from URL (Supabase Storage)
   - Determine extraction method by mimeType:
     * application/pdf → extractFromPdf
     * application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document → extractFromDocx
     * image/* → return { text: null, error: 'Image OCR not implemented' }
   - Return extraction result

5. Add console logging for extraction timing (start, complete, error)
  </action>
  <verify>TypeScript compiles, extraction functions can be imported</verify>
  <done>Text extraction service created with PDF and DOCX support</done>
</task>

<task type="auto">
  <name>Task 3: Create extraction API endpoint</name>
  <files>src/app/api/cases/[caseId]/extract/route.ts</files>
  <action>
Create POST endpoint to trigger text extraction for a case:

1. Create src/app/api/cases/[caseId]/extract/route.ts:
   - Validate caseId parameter
   - Look up Case and related Documents using Prisma
   - Return 404 if case not found

2. For each Document without extractedText:
   - Call extractTextFromDocument(storageUrl, mimeType)
   - Update Document.extractedText in database
   - Track extraction results (success/failure per document)

3. Return response:
   - Success: 200 with { extracted: count, failed: count, results: [...] }
   - Case not found: 404
   - Server error: 500

4. Add cache-control headers to prevent caching
  </action>
  <verify>POST /api/cases/[caseId]/extract triggers extraction and updates database</verify>
  <done>API endpoint triggers text extraction for case documents</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Document text extraction service with PDF and DOCX support</what-built>
  <how-to-verify>
    1. Ensure you have a test case with uploaded documents in the database
    2. Start dev server: `pnpm dev`
    3. Call the extraction endpoint:
       ```bash
       curl -X POST http://localhost:3000/api/cases/[test-case-id]/extract
       ```
    4. Verify:
       - Response shows extraction results
       - Check database: Document.extractedText populated
       - PDF text extracted correctly
       - DOCX text extracted correctly
       - Images return appropriate "not implemented" message
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] `pnpm lint` passes
- [ ] pdf-parse extracts text from PDF files
- [ ] mammoth extracts text from DOCX files
- [ ] API endpoint updates Document.extractedText
- [ ] Error handling for unsupported/corrupted files
</verification>

<success_criteria>
- Document text extraction service functional
- PDF and DOCX extraction working
- Document.extractedText populated for existing documents
- Graceful error handling for unsupported formats
- Ready for Claude AI analysis in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-analysis/03-01-SUMMARY.md` following the summary template.

Include in summary:
- Extraction libraries used
- File types supported
- Any limitations discovered
</output>
