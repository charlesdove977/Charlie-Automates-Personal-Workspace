---
phase: 04-attorney-dashboard
plan: 01
type: execute
---

<objective>
Set up secure authentication for attorney dashboard access.

Purpose: Attorneys need secure login to access their firm's case inbox. This establishes the auth foundation all dashboard features depend on.
Output: Working login flow, protected routes, and session management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-analysis/03-03-SUMMARY.md

@prisma/schema.prisma
@src/lib/db.ts
@package.json

**Tech stack available:** Next.js 16, Prisma 7, Supabase Storage, OpenAI
**Established patterns:** Multi-tenant by firmId, API routes with Cache-Control: no-store
**Constraining decisions:**
- Phase 01-02: Multi-tenant by firmId - all entities linked to Firm
- UX Philosophy: Boring, safe, professional UI

**Auth context:**
- User model exists with email, name, role (ADMIN/ATTORNEY), firmId
- Need to authenticate against existing User table
- Session must include firmId for data isolation
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Select authentication approach for attorney dashboard</decision>
  <context>Need secure login for attorneys. User model already exists in Prisma with email, name, role, firmId. Must integrate with existing multi-tenant architecture.</context>
  <options>
    <option id="nextauth">
      <name>NextAuth.js (Auth.js) with Prisma Adapter</name>
      <pros>Free, self-hosted, uses existing User model directly, Prisma adapter available, maximum control, no vendor lock-in</pros>
      <cons>More setup required, you manage security, need to handle password hashing</cons>
    </option>
    <option id="clerk">
      <name>Clerk</name>
      <pros>Beautiful pre-built UI, excellent DX, handles security for you, quick setup</pros>
      <cons>Paid after 10k MAU ($25/mo+), requires syncing users to your DB, external dependency</cons>
    </option>
    <option id="credentials-simple">
      <name>Simple credentials auth (bcrypt + JWT cookies)</name>
      <pros>No external dependencies, full control, uses existing User model, minimal abstraction</pros>
      <cons>Must implement session management manually, more security responsibility</cons>
    </option>
  </options>
  <resume-signal>Select: nextauth, clerk, or credentials-simple</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Install and configure authentication</name>
  <files>package.json, src/lib/auth.ts, src/app/api/auth/[...nextauth]/route.ts (if NextAuth), .env.local</files>
  <action>
Based on decision:

**If nextauth:**
- Install: `pnpm add next-auth @auth/prisma-adapter bcryptjs` and `pnpm add -D @types/bcryptjs`
- Create auth config in src/lib/auth.ts with CredentialsProvider
- Use Prisma adapter for session storage OR JWT strategy (JWT recommended for serverless)
- Configure NEXTAUTH_SECRET and NEXTAUTH_URL in .env.local
- Hash passwords with bcryptjs (add passwordHash to User model if not exists)

**If clerk:**
- Install: `pnpm add @clerk/nextjs`
- Create middleware.ts for route protection
- Add CLERK_SECRET_KEY and NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to .env.local
- Note: Will need webhook to sync Clerk users to local User table

**If credentials-simple:**
- Install: `pnpm add bcryptjs jose` and `pnpm add -D @types/bcryptjs`
- Create src/lib/auth.ts with login/logout functions
- Use jose for JWT (already proven pattern in this codebase context)
- Store JWT in httpOnly cookie with 24h expiry
- Add passwordHash field to User model

For all options: Add passwordHash String field to User model if not present, run prisma db push.
  </action>
  <verify>pnpm build passes, auth library installed in package.json</verify>
  <done>Auth library configured, environment variables documented, User model updated if needed</done>
</task>

<task type="auto">
  <name>Task 3: Create login page and protect dashboard routes</name>
  <files>src/app/dashboard/login/page.tsx, src/middleware.ts, src/app/dashboard/layout.tsx</files>
  <action>
Create login page at /dashboard/login:
- Professional, minimal UI matching firm branding philosophy
- Email + password form
- Error handling for invalid credentials
- Redirect to /dashboard on success
- "Forgot password" link (can be placeholder for now)

Create middleware.ts to protect /dashboard/* routes:
- Check for valid session/token
- Redirect unauthenticated users to /dashboard/login
- Allow /dashboard/login without auth

Create dashboard layout:
- Wrap dashboard pages with auth check
- Include logout functionality
- Display current user name in header

Style notes:
- Use existing Tailwind setup
- Professional, boring, safe UI (no experimental patterns)
- Match the legal industry aesthetic (blues, grays, minimal)
  </action>
  <verify>
- Visit /dashboard → redirects to /dashboard/login
- Login with valid credentials → redirects to /dashboard
- Invalid credentials → shows error message
- Logout → redirects to login
  </verify>
  <done>Login page works, dashboard routes protected, logout functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Auth library installed and configured
- [ ] Login page renders at /dashboard/login
- [ ] Protected routes redirect to login when unauthenticated
- [ ] Valid login creates session and redirects to dashboard
- [ ] Logout clears session
- [ ] `pnpm build` passes
</verification>

<success_criteria>
- Authentication decision made and documented
- Login flow works end-to-end
- Dashboard routes are protected
- Session includes user info (id, email, firmId, role)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-attorney-dashboard/04-01-SUMMARY.md`
</output>
